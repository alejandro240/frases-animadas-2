server {
    # Escuchar puerto 80
    listen 80;
    server_name localhost;
    root /var/www/html/public; # Laravel utiliza /public como raíz web

    # Tamaño máximo de subida de archivos
    client_max_body_size 25m;

    # Índice por defecto de Nginx
    index index.php index.html;

    # Configuración de logs
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;

    # 1. Gestionar peticiones de archivos estáticos (CSS, JS, Imágenes)
    # Si el archivo existe, lo sirve directamente
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # 2. Gestionar peticiones PHP (todas pasan por index.php)
    location ~ \.php$ {
        # El nombre del host aquí es el nombre del servicio de Docker Compose: 'app'
        # El puerto por defecto de PHP-FPM es 9000
        fastcgi_pass app:9000;

        # Desactivar buffer si se comunica con PHP-FPM localmente
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;

        # Incluir parámetros estándar
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # 3. Denegar acceso a archivos .env y .ht* por seguridad
    location ~ /\.env|/\.ht {
        deny all;
    }
}
